on:
  push:
    tags:
      - v*

name: Test, build, update server
jobs:
  master:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Build and start
        run: |
          docker volume create --name=od-postgres
          docker-compose -f docker-compose.dev.yml -f docker-compose.test.yml up -d

      - name: Sleep
        uses: jakejarvis/wait-action@master
        with:
          time: '30s'

      - name: Check docker state
        run: docker ps -a

      - name: Grub startup logs
        run: |
          docker logs od-backend-node

      - name: Test
        run: docker exec od-backend-node npm run test

      - name: Connect to server and update
        uses: appleboy/ssh-action@master
        env:
          FCM_KEY_FILE: ${{ secrets.FCM_KEY_FILE }}
          SERVER_REPO_PATH: ${{ secrets.SERVER_REPO_PATH }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          envs: FCM_KEY_FILE,SERVER_REPO_PATH
          script: |
            whoami
            cd $SERVER_REPO_PATH
            ls -al
            git pull
            echo $FCM_KEY_FILE > fcm.json
            docker volume create --name=od-postgres
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
